{% extends 'analytics/base.html' %}

{% block title %}Clustering Analysis - Student Analytics{% endblock %}

{% block content %}
<div class="container section">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4"><i class="bi bi-diagram-2 me-2"></i>K-Means Clustering Analysis</h2>
            <p class="text-muted">Student segmentation based on performance patterns and behavioral characteristics</p>
        </div>
    </div>

    <div class="row g-4">
        {% for cluster in clusters %}
        <div class="col-lg-4">
            <div class="card h-100 {% if cluster.id == 1 %}border-success{% elif cluster.id == 0 %}border-warning{% else %}border-danger{% endif %}">
                <div class="card-header {% if cluster.id == 1 %}bg-success{% elif cluster.id == 0 %}bg-warning{% else %}bg-danger{% endif %} text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people-fill me-2"></i>{{ cluster.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <h3 class="{% if cluster.id == 1 %}text-success{% elif cluster.id == 0 %}text-warning{% else %}text-danger{% endif %}">{{ cluster.count }}</h3>
                            <small class="text-muted">Students</small>
                        </div>
                        <div class="col-6">
                            <h3 class="{% if cluster.id == 1 %}text-success{% elif cluster.id == 0 %}text-warning{% else %}text-danger{% endif %}">{{ cluster.avg_cgpa }}</h3>
                            <small class="text-muted">Avg CGPA</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Performance Level</span>
                            <span class="fw-bold">{{ cluster.avg_cgpa }}/4.0</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar {% if cluster.id == 1 %}bg-success{% elif cluster.id == 0 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ cluster.avg_cgpa|floatformat:0|mul:25 }}%"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Attendance</span>
                            <span class="fw-bold">{{ cluster.avg_attendance }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar {% if cluster.avg_attendance >= 90 %}bg-success{% elif cluster.avg_attendance >= 75 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 style="width: {{ cluster.avg_attendance }}%"></div>
                        </div>
                    </div>

                    <h6 class="fw-bold mb-2">Key Characteristics:</h6>
                    <ul class="list-unstyled">
                        {% for characteristic in cluster.characteristics %}
                        <li class="mb-1">
                            {% if cluster.id == 1 %}
                                <i class="bi bi-check-circle text-success me-2"></i>
                            {% elif cluster.id == 0 %}
                                <i class="bi bi-dash-circle text-warning me-2"></i>
                            {% else %}
                                <i class="bi bi-x-circle text-danger me-2"></i>
                            {% endif %}
                            {{ characteristic }}
                        </li>
                        {% endfor %}
                    </ul>

                    <p class="text-muted small">{{ cluster.description }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="row mt-5">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Cluster Visualization</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="clusterScatterChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Recommendations</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success mb-2">
                        <h6 class="mb-1"><i class="bi bi-trophy me-1"></i> High Performers</h6>
                        <p class="small mb-0">Continue mentoring and leadership programs</p>
                    </div>
                    <div class="alert alert-warning mb-2">
                        <h6 class="mb-1"><i class="bi bi-arrow-up me-1"></i> Average Performers</h6>
                        <p class="small mb-0">Implement targeted skill development interventions</p>
                    </div>
                    <div class="alert alert-danger mb-0">
                        <h6 class="mb-1"><i class="bi bi-heart-pulse me-1"></i> Low Performers</h6>
                        <p class="small mb-0">Require immediate academic support and counseling</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Cluster scatter plot visualization
const ctx = document.getElementById('clusterScatterChart').getContext('2d');
new Chart(ctx, {
    type: 'scatter',
    data: {
        datasets: [{
            label: 'High Performers',
            data: [
                {x: 3.36, y: 95.0}, {x: 3.4, y: 92}, {x: 3.5, y: 98}, 
                {x: 3.3, y: 94}, {x: 3.45, y: 96}
            ],
            backgroundColor: 'rgba(40, 167, 69, 0.7)',
            borderColor: 'rgba(40, 167, 69, 1)',
            pointRadius: 6
        }, {
            label: 'Average Performers',
            data: [
                {x: 3.22, y: 81.5}, {x: 3.1, y: 82}, {x: 3.3, y: 78}, 
                {x: 3.2, y: 85}, {x: 3.15, y: 80}
            ],
            backgroundColor: 'rgba(255, 193, 7, 0.7)',
            borderColor: 'rgba(255, 193, 7, 1)',
            pointRadius: 6
        }, {
            label: 'Low Performers',
            data: [
                {x: 0.21, y: 94.6}, {x: 2.1, y: 60}, {x: 2.3, y: 68}, 
                {x: 2.0, y: 65}, {x: 1.8, y: 58}
            ],
            backgroundColor: 'rgba(220, 53, 69, 0.7)',
            borderColor: 'rgba(220, 53, 69, 1)',
            pointRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'CGPA'
                },
                min: 0,
                max: 4
            },
            y: {
                title: {
                    display: true,
                    text: 'Attendance %'
                },
                min: 0,
                max: 100
            }
        },
        plugins: {
            title: {
                display: true,
                text: 'Student Clusters: CGPA vs Attendance'
            },
            legend: {
                display: true,
                position: 'bottom'
            }
        }
    }
});
</script>
{% endblock %}
